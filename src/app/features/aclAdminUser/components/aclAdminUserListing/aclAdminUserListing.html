<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button label="New" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    </ng-template>
</p-toolbar>

<p-table #dt [value]="users()" [rows]="10" [paginator]="true"
    [globalFilterFields]="['username', 'email', 'mobile', 'status', 'usertype']" [(selection)]="selectedUsers"
    dataKey="autoid" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
    [showCurrentPageReport]="true" [rowsPerPageOptions]="[10, 20, 30]" [loading]="loading()"
    [expandedRowKeys]="expandedRows()" (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)">
    <ng-template pTemplate="loading">
        <tr *ngFor="let _ of [0,1,2,3,4,5]">
            <td colspan="9">
                <div class="flex items-center gap-4 py-2">
                    <p-skeleton shape="circle" size="2rem"></p-skeleton>
                    <div class="flex-1">
                        <p-skeleton width="60%" height="1rem"></p-skeleton>
                        <p-skeleton width="40%" height="0.8rem" style="margin-top: 6px"></p-skeleton>
                    </div>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template #caption>
        <div class="flex items-center justify-between">
            <h5 class="m-0">Manage Users</h5>
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..." />
            </p-iconfield>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th style="width: 3.5rem"></th>
            <th>Username</th>
            <th>Email</th>
            <!-- <th>Mobile</th> -->
            <!-- <th>User Type</th> -->
            <!-- <th>Status</th> -->
            <th>Created</th>
            <th>Sites</th>
            <th>Action</th>
        </tr>
    </ng-template>

    <ng-template #body let-user let-expanded="expanded">
        <tr>
            <td>
                <p-button type="button" pRipple (click)="toggleRow(user)" [text]="true" severity="secondary"
                    [rounded]="true" [icon]="isRowExpanded(user) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />

            </td>
            <td class="flex items-center gap-3">
                <!-- <img [src]="user.profileImage ? user.profileImage : (user.opSites?.length ? user.opSites[0].siteLogo : 'assets/default-avatar.png')" alt="avatar" class="avatar" /> -->
                <div>
                    <div class="font-semibold">{{ user.username }}</div>
                    <div class="text-sm text-gray-500">{{ user.email }}</div>
                </div>
            </td>
            <td>{{ user.email }}</td>
            <!-- <td>{{ user.mobile }}</td> -->
            <!-- <td>{{ user.usertype }}</td> -->
            <!-- <td>
                <p-tag [value]="user.status" [severity]="getSeverity(user.status)"></p-tag>
            </td> -->
            <td>{{ user.createddate | date:'dd-MMM-yyyy' }}</td>
            <td>
                <span *ngIf="user.opSites?.length">{{ user.opSites.length }} site(s)</span>
                <span *ngIf="!user.opSites || user.opSites.length === 0">-</span>
            </td>
            <td>
                <p-button icon="pi pi-pencil" class="mr-2" [outlined]="true" (click)="editUser(user)"></p-button>
                <!-- <p-button icon="pi pi-trash" severity="danger" [outlined]="true" (click)="deleteUser(user)"></p-button> -->
            </td>
        </tr>
    </ng-template>

    <ng-template #expandedrow let-user>
        <tr>
            <td colspan="9">
                <div class="p-4">
                    <h6 class="mb-3">Operational Sites for {{ user.username }}</h6>

                    <p-table [value]="user.opSites" dataKey="autoid" [rowExpandMode]="'single'" sortMode="multiple"
                        responsiveLayout="scroll">
                        <!-- ================= HEADER ================= -->
                        <ng-template pTemplate="header">
        <tr>
            <th style="width: 3rem"></th>

            <th pSortableColumn="siteName">
                Site
                <p-sortIcon field="siteName"></p-sortIcon>
            </th>

            <th pSortableColumn="city">
                Location
                <p-sortIcon field="city"></p-sortIcon>
            </th>

            <th pSortableColumn="status">
                Status
                <p-sortIcon field="status"></p-sortIcon>
            </th>

            <th pSortableColumn="siteParkingCapacity">
                Parking
                <p-sortIcon field="siteParkingCapacity"></p-sortIcon>
            </th>

            <th>Services</th>
        </tr>
    </ng-template>

    <!-- ================= BODY ================= -->
    <ng-template pTemplate="body" let-site let-expanded="expanded">
        <tr>
            <!-- Expand only if services exist -->
            <td>
                <button *ngIf="site.services?.length > 0" pButton type="button" pRowToggler
                    class="p-button-text p-button-sm"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            </td>

            <td class="">
                <img [src]="site.siteLogo || 'assets/default-site.png'" width="28" class="border-round" />
                {{ site.siteName }}
            </td>

            <td>
                {{ site.city }}, {{ site.province }}
                <div class="text-xs text-gray-500">{{ site.siteAddress }}</div>
            </td>

            <td>
                <p-tag [value]="site.status" severity="success"></p-tag>
            </td>

            <td>{{ site.siteParkingCapacity }}</td>

            <td>{{ site.services?.length || 0 }} Service(s)</td>
        </tr>
    </ng-template>

    <!-- ================= SITE â†’ SERVICES EXPANSION ================= -->
    <ng-template #expandeSubrow let-site>
        <tr>
            <td colspan="6">
                <div class="p-3 bg-gray-50 border-round">
                    <h6 class="mb-2">Services</h6>

                    <p-table [value]="site.services" dataKey="serviceId" sortMode="multiple" size="small">
                        <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="serviceName">
                Service Name
                <p-sortIcon field="serviceName"></p-sortIcon>
            </th>

            <th pSortableColumn="status">
                Status
                <p-sortIcon field="status"></p-sortIcon>
            </th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-service>
        <tr>
            <td>{{ service.serviceName }}</td>
            <td>
                <p-tag [value]="service.status" severity="info"></p-tag>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="2">No services assigned.</td>
        </tr>
    </ng-template>
</p-table>
</div>
</td>
</tr>
</ng-template>

<!-- ================= EMPTY ================= -->
<ng-template pTemplate="emptymessage">
    <tr>
        <td colspan="6">No operational sites assigned.</td>
    </tr>
</ng-template>
</p-table>
</div>
</td>
</tr>
</ng-template>
</p-table>

<!-- Create or Edit Dialog Component -->
<app-create-or-edit-acl-admin-user [visible]="dialogVisible()" [user]="selectedUser()" (userSaved)="onUserSaved($event)"
    (closed)="onDialogClosed()"> </app-create-or-edit-acl-admin-user>